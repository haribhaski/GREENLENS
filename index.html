<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GreenLens - Carbon Footprint Scanner</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-green: #22c55e;
            --secondary-green: #16a34a;
            --light-green: #dcfce7;
            --dark-green: #166534;
            --white: #ffffff;
            --light-gray: #f8fafc;
            --gray: #64748b;
            --dark-gray: #334155;
            --danger: #ef4444;
            --warning: #f59e0b;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-lg: rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--light-green) 0%, var(--white) 50%, var(--light-green) 100%);
            min-height: 100vh;
            color: var(--dark-gray);
            line-height: 1.6;
        }

        /* Animated Background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .floating-leaf {
            position: absolute;
            font-size: 2rem;
            color: var(--primary-green);
            opacity: 0.1;
            animation: float 15s infinite linear;
        }

        @keyframes float {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.1; }
            90% { opacity: 0.1; }
            100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
            padding: 60px 0;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px var(--shadow-lg);
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Ccircle cx='30' cy='30' r='4'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
            animation: backgroundMove 20s linear infinite;
        }

        @keyframes backgroundMove {
            0% { transform: translateX(0) translateY(0); }
            100% { transform: translateX(-60px) translateY(-60px); }
        }

        .header-content {
            position: relative;
            z-index: 2;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            animation: logoFloat 3s ease-in-out infinite;
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .logo-icon {
            font-size: 4rem;
            margin-right: 20px;
            background: linear-gradient(45deg, var(--white), var(--light-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
        }

        .header h1 {
            font-size: 4rem;
            font-weight: 700;
            color: var(--white);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            letter-spacing: -1px;
        }

        .header .subtitle {
            font-size: 1.3rem;
            color: var(--light-green);
            font-weight: 300;
            margin-bottom: 30px;
            opacity: 0.9;
        }

        .connection-status {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .connection-status.connected {
            background: var(--primary-green);
            color: var(--white);
        }

        .connection-status.disconnected {
            background: var(--danger);
            color: var(--white);
        }

        .connection-status.checking {
            background: var(--warning);
            color: var(--white);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }

        /* Card Styles */
        .card {
            background: var(--white);
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 20px 60px var(--shadow);
            border: 1px solid rgba(34, 197, 94, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-green), var(--secondary-green));
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 80px var(--shadow-lg);
        }

        .card-title {
            display: flex;
            align-items: center;
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--dark-green);
            margin-bottom: 30px;
        }

        .card-title i {
            margin-right: 15px;
            font-size: 2rem;
            background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Upload Section */
        .upload-area {
            border: 3px dashed var(--primary-green);
            border-radius: 20px;
            padding: 60px 40px;
            text-align: center;
            transition: all 0.4s ease;
            cursor: pointer;
            background: linear-gradient(135deg, var(--light-green), var(--white));
            position: relative;
            overflow: hidden;
        }

        .upload-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }

        .upload-area:hover::before {
            left: 100%;
        }

        .upload-area:hover {
            border-color: var(--secondary-green);
            background: linear-gradient(135deg, var(--white), var(--light-green));
            transform: translateY(-5px);
            box-shadow: 0 20px 40px var(--shadow);
        }

        .upload-area.dragover {
            border-color: var(--secondary-green);
            background: linear-gradient(135deg, var(--light-green), var(--primary-green));
            color: var(--white);
        }

        .upload-area.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        .upload-icon {
            font-size: 5rem;
            color: var(--primary-green);
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .upload-area h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--dark-green);
        }

        .upload-area p {
            color: var(--gray);
            margin-bottom: 25px;
        }

        #imageInput {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
            color: var(--white);
            padding: 15px 35px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 10px 30px rgba(34, 197, 94, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(34, 197, 94, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--warning), #f97316);
            box-shadow: 0 10px 30px rgba(249, 115, 22, 0.3);
        }

        .btn-secondary:hover {
            box-shadow: 0 15px 40px rgba(249, 115, 22, 0.4);
        }

        /* Progress Bar Enhanced */
        .progress-container {
            margin: 30px 0;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: var(--light-gray);
            border-radius: 25px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px var(--shadow);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-green), var(--secondary-green));
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 25px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background-image: linear-gradient(
                -45deg,
                rgba(255, 255, 255, .2) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255, 255, 255, .2) 50%,
                rgba(255, 255, 255, .2) 75%,
                transparent 75%,
                transparent
            );
            background-size: 50px 50px;
            animation: move 2s linear infinite;
        }

        @keyframes move {
            0% { background-position: 0 0; }
            100% { background-position: 50px 50px; }
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            color: var(--gray);
            font-size: 0.9rem;
        }

        /* Results Section */
        .ocr-results {
            background: var(--light-gray);
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            min-height: 150px;
            border-left: 6px solid var(--primary-green);
        }

        .product-item {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 5px 20px var(--shadow);
            border-left: 6px solid var(--warning);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .product-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-green), var(--secondary-green));
        }

        .product-item:hover {
            transform: translateX(10px);
            box-shadow: 0 10px 30px var(--shadow-lg);
        }

        .carbon-score {
            background: linear-gradient(135deg, var(--warning), #f97316);
            color: var(--white);
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: 600;
            display: inline-block;
            margin-left: 15px;
            box-shadow: 0 5px 15px rgba(249, 115, 22, 0.3);
        }

        .carbon-score.low {
            background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
            box-shadow: 0 5px 15px rgba(34, 197, 94, 0.3);
        }

        .carbon-score.medium {
            background: linear-gradient(135deg, var(--warning), #f97316);
            box-shadow: 0 5px 15px rgba(249, 115, 22, 0.3);
        }

        .carbon-score.high {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
        }

        /* Statistics Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-top: 40px;
        }

        .stat-card {
            background: var(--white);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 15px 40px var(--shadow);
            transition: all 0.3s ease;
            border-top: 5px solid var(--primary-green);
        }

        .stat-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 25px 60px var(--shadow-lg);
        }

        .stat-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--dark-green);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--gray);
            font-weight: 500;
        }

        /* Image Preview */
        .image-preview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 15px;
            margin: 25px 0;
            box-shadow: 0 15px 40px var(--shadow);
            object-fit: cover;
        }

        /* Alternatives Section */
        .alternatives-section {
            background: var(--white);
            border-radius: 25px;
            padding: 40px;
            margin-top: 30px;
            box-shadow: 0 20px 60px var(--shadow);
            border-top: 5px solid var(--primary-green);
        }

        .alternative-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            margin: 15px 0;
            background: linear-gradient(135deg, var(--light-green), var(--white));
            border-radius: 15px;
            border-left: 6px solid var(--primary-green);
            transition: all 0.3s ease;
        }

        .alternative-item:hover {
            transform: translateX(10px);
            background: linear-gradient(135deg, var(--white), var(--light-green));
        }

        .savings-badge {
            background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
            color: var(--white);
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(34, 197, 94, 0.3);
        }

        /* NEW: Meal Planning Styles */
        .meal-planning-section {
            margin-top: 60px;
        }

        .meal-planning-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-green);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--light-gray);
            border-radius: 15px;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: var(--light-gray);
            border-radius: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .checkbox-item:hover {
            background: var(--light-green);
        }

        .checkbox-item input {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .meal-plan-result, .shopping-list-result {
            background: var(--white);
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 15px 40px var(--shadow);
            border-left: 6px solid var(--primary-green);
        }

        .day-plan {
            background: var(--light-gray);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid var(--secondary-green);
        }

        .meal-item {
            background: var(--white);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 3px 10px var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .carbon-badge {
            background: var(--primary-green);
            color: var(--white);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .category-section {
            background: var(--light-green);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
        }

        .shopping-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(34, 197, 94, 0.1);
        }

        .shopping-item:last-child {
            border-bottom: none;
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid var(--light-green);
            border-top: 3px solid var(--primary-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error and notification styles */
        .error-message {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: var(--white);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
        }

        .success-message {
            background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
            color: var(--white);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 10px 30px rgba(34, 197, 94, 0.3);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-layout, .meal-planning-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
            
            .card {
                padding: 25px;
            }
            
            .upload-area {
                padding: 40px 20px;
            }

            .connection-status {
                position: relative;
                top: auto;
                right: auto;
                margin-top: 20px;
                display: inline-block;
            }

            .checkbox-group {
                grid-template-columns: 1fr;
            }
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeInUp 0.6s ease-out;
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: var(--dark-gray);
            color: var(--white);
            text-align: center;
            border-radius: 10px;
            padding: 10px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9rem;
            box-shadow: 0 10px 30px var(--shadow-lg);
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--dark-gray) transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="bg-animation" id="bgAnimation"></div>
    
    <!-- Enhanced Header -->
    <div class="header">
        <div class="connection-status" id="connectionStatus">Checking Connection...</div>
        <div class="header-content">
            <div class="logo-container">
                <div class="logo-icon">🌱</div>
                <h1>GreenLens</h1>
            </div>
            <p class="subtitle">AI-Powered Receipt Analysis & Sustainable Meal Planning</p>
        </div>
    </div>

    <div class="container">
        <div class="main-layout">
            <!-- Upload Section -->
            <div class="card fade-in">
                <h2 class="card-title">
                    <i class="fas fa-camera-retro"></i>
                    Scan Receipt
                </h2>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h3>Drop your receipt here</h3>
                    <p>AI-powered OCR will extract and analyze your purchases</p>
                    <input type="file" id="imageInput" accept="image/*">
                    <button class="btn" id="uploadBtn">
                        <i class="fas fa-plus"></i>
                        Choose Receipt
                    </button>
                </div>
                
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Processing...</div>
                </div>

                <div id="imagePreview"></div>
            </div>

            <!-- Results Section -->
            <div class="card fade-in">
                <h2 class="card-title">
                    <i class="fas fa-chart-line"></i>
                    Analysis Results
                </h2>
                <div class="ocr-results" id="ocrResults">
                    <div style="text-align: center; padding: 40px; color: var(--gray);">
                        <i class="fas fa-receipt" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;"></i>
                        <p>Upload a receipt to see detailed carbon footprint analysis powered by our advanced OCR and environmental database...</p>
                    </div>
                </div>
                
                <div id="productAnalysis"></div>
            </div>
        </div>

        <!-- Statistics Grid -->
        <div class="stats-grid" id="statsGrid" style="display: none;">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-leaf"></i>
                </div>
                <div class="stat-value" id="totalCarbon">0</div>
                <div class="stat-label">kg CO₂ Total Footprint</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="stat-value" id="productCount">0</div>
                <div class="stat-label">Products Analyzed</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-percentage"></i>
                </div>
                <div class="stat-value" id="matchRate">0</div>
                <div class="stat-label">% Match Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-award"></i>
                </div>
                <div class="stat-value" id="ecoScore">-</div>
                <div class="stat-label">Environmental Score</div>
            </div>
        </div>

        <!-- Alternatives Section -->
        <div class="alternatives-section" id="alternativesSection" style="display: none;">
            <h2 class="card-title">
                <i class="fas fa-exchange-alt"></i>
                Sustainable Alternatives & Recommendations
            </h2>
            <div id="alternatives"></div>
        </div>

        <!-- NEW: Meal Planning Section -->
        <div class="meal-planning-section">
            <div class="meal-planning-grid">
                <!-- Meal Prep Planning -->
                <div class="card fade-in">
                    <h2 class="card-title">
                        <i class="fas fa-utensils"></i>
                        Carbon-Optimized Meal Prep
                    </h2>
                    
                    <div class="form-group">
                        <label class="form-label">Weekly Budget ($)</label>
                        <input type="number" class="form-input" id="mealBudget" placeholder="e.g., 75" min="20" max="500">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Number of People</label>
                        <select class="form-select" id="peopleCount">
                            <option value="1">1 Person</option>
                            <option value="2">2 People</option>
                            <option value="3">3 People</option>
                            <option value="4">4 People</option>
                            <option value="5">5+ People</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Dietary Preferences</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" id="vegetarian" value="vegetarian">
                                <span>Vegetarian</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="vegan" value="vegan">
                                <span>Vegan</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="glutenFree" value="gluten-free">
                                <span>Gluten-Free</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="dairyFree" value="dairy-free">
                                <span>Dairy-Free</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="lowCarb" value="low-carb">
                                <span>Low-Carb</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="keto" value="keto">
                                <span>Keto</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Additional Preferences/Allergies</label>
                        <textarea class="form-textarea" id="additionalPrefs" placeholder="e.g., no seafood, prefer organic, seasonal ingredients..."></textarea>
                    </div>

                    <button class="btn" id="generateMealPlan">
                        <i class="fas fa-magic"></i>
                        Generate Meal Plan
                    </button>

                    <div class="progress-container" id="mealPlanProgress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="mealPlanProgressFill"></div>
                        </div>
                        <div class="progress-text" id="mealPlanProgressText">AI is creating your sustainable meal plan...</div>
                    </div>

                    <div id="mealPlanResults"></div>
                </div>

                <!-- Smart Shopping List -->
                <div class="card fade-in">
                    <h2 class="card-title">
                        <i class="fas fa-list-check"></i>
                        Smart Shopping List Generator
                    </h2>
                    
                    <div class="form-group">
                        <label class="form-label">Shopping Budget ($)</label>
                        <input type="number" class="form-input" id="shoppingBudget" placeholder="e.g., 100" min="30" max="1000">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Meal Planning Duration</label>
                        <select class="form-select" id="planDuration">
                            <option value="week">This Week</option>
                            <option value="2weeks">Next 2 Weeks</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Priority Focus</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="radio" name="priority" value="carbon" id="priorityCarbon">
                                <span>Lowest Carbon Footprint</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="radio" name="priority" value="cost" id="priorityCost">
                                <span>Best Value for Money</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="radio" name="priority" value="balanced" id="priorityBalanced" checked>
                                <span>Balanced Approach</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Current Pantry Items (optional)</label>
                        <textarea class="form-textarea" id="pantryItems" placeholder="e.g., rice, pasta, canned beans, olive oil..."></textarea>
                    </div>

                    <button class="btn btn-secondary" id="generateShoppingList">
                        <i class="fas fa-shopping-cart"></i>
                        Generate Smart List
                    </button>

                    <div class="progress-container" id="shoppingProgress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="shoppingProgressFill"></div>
                        </div>
                        <div class="progress-text" id="shoppingProgressText">AI is optimizing your shopping list...</div>
                    </div>

                    <div id="shoppingListResults"></div>
                </div>
            </div>

            <!-- Meal Plan Display -->
            <div class="meal-plan-result" id="mealPlanDisplay" style="display: none;">
                <h3 style="color: var(--dark-green); margin-bottom: 20px; display: flex; align-items: center;">
                    <i class="fas fa-calendar-week" style="margin-right: 10px; color: var(--primary-green);"></i>
                    Your Sustainable Weekly Meal Plan
                </h3>
                <div id="mealPlanContent"></div>
            </div>

            <!-- Shopping List Display -->
            <div class="shopping-list-result" id="shoppingListDisplay" style="display: none;">
                <h3 style="color: var(--dark-green); margin-bottom: 20px; display: flex; align-items: center;">
                    <i class="fas fa-list" style="margin-right: 10px; color: var(--primary-green);"></i>
                    Your Optimized Shopping List
                </h3>
                <div id="shoppingListContent"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:5100';
        
        // State management
        let isProcessing = false;
        let isMealPlanGenerating = false;
        let isShoppingListGenerating = false;
        let connectionStatus = 'checking';

        // DOM Elements - Existing
        const uploadArea = document.getElementById('uploadArea');
        const imageInput = document.getElementById('imageInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const ocrResults = document.getElementById('ocrResults');
        const imagePreview = document.getElementById('imagePreview');
        const connectionStatusEl = document.getElementById('connectionStatus');
        const productAnalysis = document.getElementById('productAnalysis');
        const statsGrid = document.getElementById('statsGrid');
        const alternativesSection = document.getElementById('alternativesSection');
        const alternatives = document.getElementById('alternatives');

        // DOM Elements - NEW Meal Planning
        const generateMealPlanBtn = document.getElementById('generateMealPlan');
        const mealPlanProgress = document.getElementById('mealPlanProgress');
        const mealPlanProgressFill = document.getElementById('mealPlanProgressFill');
        const mealPlanProgressText = document.getElementById('mealPlanProgressText');
        const mealPlanResults = document.getElementById('mealPlanResults');
        const mealPlanDisplay = document.getElementById('mealPlanDisplay');
        const mealPlanContent = document.getElementById('mealPlanContent');

        const generateShoppingListBtn = document.getElementById('generateShoppingList');
        const shoppingProgress = document.getElementById('shoppingProgress');
        const shoppingProgressFill = document.getElementById('shoppingProgressFill');
        const shoppingProgressText = document.getElementById('shoppingProgressText');
        const shoppingListResults = document.getElementById('shoppingListResults');
        const shoppingListDisplay = document.getElementById('shoppingListDisplay');
        const shoppingListContent = document.getElementById('shoppingListContent');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async () => {
            await checkBackendConnection();
            createFloatingLeaves();
            setupEventListeners();
            
            console.log('🌱 GreenLens Enhanced with Meal Planning Initialized');
            console.log('Backend Integration: Enabled');
            console.log('Features: Receipt OCR, Carbon Analysis, Meal Planning, Shopping Lists');
        });

        // Check backend connection
        async function checkBackendConnection() {
            try {
                connectionStatusEl.textContent = 'Checking Connection...';
                connectionStatusEl.className = 'connection-status checking';
                
                console.log('Attempting to connect to:', `${API_BASE_URL}/health`);
                
                const response = await fetch(`${API_BASE_URL}/health`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (response.ok) {
                    const data = await response.json();
                    connectionStatus = 'connected';
                    connectionStatusEl.textContent = `✓ Connected - v${data.version || 'Unknown'}`;
                    connectionStatusEl.className = 'connection-status connected';
                    
                    console.log('Backend connected successfully');
                    console.log('Available endpoints:', data.available_endpoints || 'Not provided');
                    console.log('Backend services:', data.services);
                    console.log('Available features:', data.features);
                } else {
                    const errorData = await response.text();
                    console.error('Backend health check failed:', response.status, errorData);
                    throw new Error(`HTTP ${response.status}: ${errorData}`);
                }
            } catch (error) {
                connectionStatus = 'disconnected';
                connectionStatusEl.textContent = '✗ Backend Offline';
                connectionStatusEl.className = 'connection-status disconnected';
                
                console.error('Backend connection failed:', error);
                
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    showNotification('Cannot reach backend server. Is it running on port 5100?', 'error');
                } else if (error.message.includes('404')) {
                    showNotification('Backend endpoints not found. Check server configuration.', 'error');
                } else {
                    showNotification(`Backend connection failed: ${error.message}`, 'error');
                }
                
                disableFeatures(true);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Existing receipt scanning listeners
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            uploadArea.addEventListener('click', () => {
                console.log('Upload area clicked');
                imageInput.click();
            });
            
            uploadBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                console.log('Upload button clicked');
                imageInput.click();
            });
            
            imageInput.addEventListener('change', handleFileSelect);

            // NEW: Meal planning listeners
            generateMealPlanBtn.addEventListener('click', handleGenerateMealPlan);
            generateShoppingListBtn.addEventListener('click', handleGenerateShoppingList);
        }

        // NEW: Handle meal plan generation
        async function handleGenerateMealPlan() {
            if (isMealPlanGenerating || connectionStatus !== 'connected') {
                return;
            }

            const budget = document.getElementById('mealBudget').value;
            const peopleCount = document.getElementById('peopleCount').value;
            const additionalPrefs = document.getElementById('additionalPrefs').value;

            if (!budget || budget < 20) {
                showNotification('Please enter a valid budget (minimum $20)', 'error');
                return;
            }

            // Collect dietary preferences
            const dietaryPrefs = [];
            ['vegetarian', 'vegan', 'glutenFree', 'dairyFree', 'lowCarb', 'keto'].forEach(id => {
                if (document.getElementById(id).checked) {
                    dietaryPrefs.push(document.getElementById(id).value);
                }
            });

            setMealPlanGenerating(true);

            try {
                const requestData = {
                    budget: parseFloat(budget),
                    people_count: parseInt(peopleCount),
                    dietary_preferences: dietaryPrefs,
                    additional_preferences: additionalPrefs,
                    optimize_for: 'carbon_footprint'
                };

                updateMealPlanProgress(10, 'Connecting to AI meal planner...');
                
                const response = await fetch(`${API_BASE_URL}/api/generate-meal-plan`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                updateMealPlanProgress(60, 'AI is creating your personalized meal plan...');

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                const result = await response.json();
                
                updateMealPlanProgress(100, 'Meal plan ready!');
                
                if (result.success) {
                    displayMealPlan(result);
                    showNotification(`Meal plan generated! Total carbon footprint: ${result.summary.total_carbon_footprint} kg CO₂`, 'success');
                } else {
                    throw new Error(result.error || 'Meal plan generation failed');
                }

            } catch (error) {
                console.error('Meal plan generation failed:', error);
                showNotification('Failed to generate meal plan. Please try again.', 'error');
                displayMealPlanError(error);
            } finally {
                setMealPlanGenerating(false);
            }
        }

        // NEW: Handle shopping list generation
        async function handleGenerateShoppingList() {
            if (isShoppingListGenerating || connectionStatus !== 'connected') {
                return;
            }

            const budget = document.getElementById('shoppingBudget').value;
            const duration = document.getElementById('planDuration').value;
            const pantryItems = document.getElementById('pantryItems').value;

            if (!budget || budget < 30) {
                showNotification('Please enter a valid budget (minimum $30)', 'error');
                return;
            }

            // Get priority
            const priorityRadios = document.getElementsByName('priority');
            let priority = 'balanced';
            for (const radio of priorityRadios) {
                if (radio.checked) {
                    priority = radio.value;
                    break;
                }
            }

            setShoppingListGenerating(true);

            try {
                const requestData = {
                    budget: parseFloat(budget),
                    duration: duration,
                    priority: priority,
                    pantry_items: pantryItems ? pantryItems.split(',').map(item => item.trim()) : [],
                    optimize_for: priority
                };

                updateShoppingProgress(10, 'Analyzing carbon data...');
                
                const response = await fetch(`${API_BASE_URL}/api/generate-shopping-list`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                updateShoppingProgress(70, 'Optimizing for sustainability...');

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                const result = await response.json();
                
                updateShoppingProgress(100, 'Shopping list optimized!');
                
                if (result.success) {
                    displayShoppingList(result);
                    showNotification(`Smart shopping list generated! Estimated carbon footprint: ${result.summary.estimated_carbon_footprint} kg CO₂`, 'success');
                } else {
                    throw new Error(result.error || 'Shopping list generation failed');
                }

            } catch (error) {
                console.error('Shopping list generation failed:', error);
                showNotification('Failed to generate shopping list. Please try again.', 'error');
                displayShoppingListError(error);
            } finally {
                setShoppingListGenerating(false);
            }
        }

        // NEW: Display meal plan results
        function displayMealPlan(result) {
            if (!result.meal_plan || result.meal_plan.length === 0) {
                mealPlanContent.innerHTML = '<div class="error-message">No meal plan could be generated with the given parameters.</div>';
                return;
            }

            let content = `
                <div style="background: var(--light-green); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
                        <div>
                            <strong style="color: var(--dark-green);">Total Budget</strong><br>
                            <span style="font-size: 1.2rem;">${result.summary.total_cost.toFixed(2)}</span>
                        </div>
                        <div>
                            <strong style="color: var(--dark-green);">Carbon Footprint</strong><br>
                            <span style="font-size: 1.2rem;">${result.summary.total_carbon_footprint.toFixed(2)} kg CO₂</span>
                        </div>
                        <div>
                            <strong style="color: var(--dark-green);">Total Meals</strong><br>
                            <span style="font-size: 1.2rem;">${result.summary.total_meals}</span>
                        </div>
                        <div>
                            <strong style="color: var(--dark-green);">Avg per Meal</strong><br>
                            <span style="font-size: 1.2rem;">${result.summary.avg_cost_per_meal.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
            `;

            result.meal_plan.forEach(day => {
                content += `
                    <div class="day-plan">
                        <h4 style="color: var(--dark-green); margin-bottom: 15px; display: flex; align-items: center;">
                            <i class="fas fa-calendar-day" style="margin-right: 10px;"></i>
                            ${day.day}
                            <span class="carbon-badge" style="margin-left: auto;">${day.daily_carbon.toFixed(2)} kg CO₂</span>
                        </h4>
                        
                        ${day.meals.map(meal => `
                            <div class="meal-item">
                                <div>
                                    <strong style="color: var(--dark-green);">${meal.name}</strong>
                                    <br>
                                    <small style="color: var(--gray);">${meal.type} • ${meal.prep_time} min prep</small>
                                    ${meal.description ? `<br><span style="font-size: 0.9rem;">${meal.description}</span>` : ''}
                                </div>
                                <div style="text-align: right;">
                                    <div class="carbon-badge" style="background: ${getCarbonColor(meal.carbon_footprint)};">
                                        ${meal.carbon_footprint.toFixed(2)} kg CO₂
                                    </div>
                                    <small style="color: var(--gray); margin-top: 5px; display: block;">${meal.estimated_cost.toFixed(2)}</small>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            });

            if (result.tips && result.tips.length > 0) {
                content += `
                    <div style="background: var(--white); padding: 20px; border-radius: 15px; margin-top: 20px; border-left: 4px solid var(--primary-green);">
                        <h4 style="color: var(--dark-green); margin-bottom: 15px;">
                            <i class="fas fa-lightbulb" style="margin-right: 10px;"></i>
                            Sustainability Tips
                        </h4>
                        ${result.tips.map(tip => `
                            <div style="margin: 10px 0; padding: 10px; background: var(--light-gray); border-radius: 8px;">
                                ${tip}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            mealPlanContent.innerHTML = content;
            mealPlanDisplay.style.display = 'block';
            mealPlanDisplay.classList.add('fade-in');
        }

        // NEW: Display shopping list results  
        function displayShoppingList(result) {
            if (!result.shopping_list || Object.keys(result.shopping_list).length === 0) {
                shoppingListContent.innerHTML = '<div class="error-message">No shopping list could be generated with the given parameters.</div>';
                return;
            }

            let content = `
                <div style="background: var(--light-green); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
                        <div>
                            <strong style="color: var(--dark-green);">Total Budget</strong><br>
                            <span style="font-size: 1.2rem;">${result.summary.total_cost.toFixed(2)}</span>
                        </div>
                        <div>
                            <strong style="color: var(--dark-green);">Carbon Footprint</strong><br>
                            <span style="font-size: 1.2rem;">${result.summary.estimated_carbon_footprint.toFixed(2)} kg CO₂</span>
                        </div>
                        <div>
                            <strong style="color: var(--dark-green);">Total Items</strong><br>
                            <span style="font-size: 1.2rem;">${result.summary.total_items}</span>
                        </div>
                        <div>
                            <strong style="color: var(--dark-green);">Savings</strong><br>
                            <span style="font-size: 1.2rem; color: var(--primary-green);">${result.summary.potential_savings.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
            `;

            Object.entries(result.shopping_list).forEach(([category, items]) => {
                content += `
                    <div class="category-section">
                        <h4 style="color: var(--dark-green); margin-bottom: 15px; display: flex; align-items: center;">
                            <i class="fas fa-tags" style="margin-right: 10px;"></i>
                            ${category.charAt(0).toUpperCase() + category.slice(1)}
                            <span style="margin-left: auto; font-size: 0.9rem; opacity: 0.8;">${items.length} items</span>
                        </h4>
                        
                        ${items.map(item => `
                            <div class="shopping-item">
                                <div>
                                    <strong>${item.name}</strong>
                                    ${item.quantity ? `<span style="color: var(--gray);"> • ${item.quantity}</span>` : ''}
                                    ${item.brand_preference ? `<br><small style="color: var(--gray);">Recommended: ${item.brand_preference}</small>` : ''}
                                </div>
                                <div style="text-align: right;">
                                    <strong style="color: var(--dark-green);">${item.estimated_price.toFixed(2)}</strong>
                                    <br><small style="color: var(--gray);">${item.carbon_footprint.toFixed(2)} kg CO₂</small>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            });

            if (result.alternatives && result.alternatives.length > 0) {
                content += `
                    <div style="background: var(--white); padding: 20px; border-radius: 15px; margin-top: 20px; border-left: 4px solid var(--primary-green);">
                        <h4 style="color: var(--dark-green); margin-bottom: 15px;">
                            <i class="fas fa-exchange-alt" style="margin-right: 10px;"></i>
                            Sustainable Alternatives
                        </h4>
                        ${result.alternatives.map(alt => `
                            <div style="margin: 15px 0; padding: 15px; background: var(--light-gray); border-radius: 10px;">
                                <strong style="color: var(--dark-green);">${alt.original_item} → ${alt.alternative}</strong>
                                <br><span style="color: var(--gray); font-size: 0.9rem;">${alt.reason}</span>
                                <br><span style="color: var(--primary-green); font-weight: 600;">Save: ${alt.carbon_savings.toFixed(2)} kg CO₂ • ${alt.cost_savings.toFixed(2)}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            shoppingListContent.innerHTML = content;
            shoppingListDisplay.style.display = 'block';
            shoppingListDisplay.classList.add('fade-in');
        }

        // Existing functions continue as before...
        // [All previous functions from the original code remain the same]

        // Drag and drop handlers
        function handleDragOver(e) {
            e.preventDefault();
            if (!isProcessing && connectionStatus === 'connected') {
                uploadArea.classList.add('dragover');
            }
        }

        function handleDragLeave() {
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            if (isProcessing || connectionStatus !== 'connected') {
                return;
            }
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            console.log('File selected:', e.target.files.length);
            if (e.target.files.length > 0) {
                console.log('Processing file:', e.target.files[0].name);
                handleFile(e.target.files[0]);
            }
        }

        // Main file handling function
        async function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showNotification('Please upload an image file (PNG, JPG, JPEG)', 'error');
                return;
            }

            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                showNotification('File size too large. Please upload an image under 10MB.', 'error');
                return;
            }

            if (connectionStatus !== 'connected') {
                showNotification('Backend server is not available', 'error');
                return;
            }

            setProcessingState(true);
            showImagePreview(file);
            
            try {
                const base64Image = await fileToBase64(file);
                await processReceiptWithBackend(base64Image);
                
            } catch (error) {
                console.error('File processing error:', error);
                showNotification('Failed to process receipt. Please try again.', 'error');
                displayError(error);
            } finally {
                setProcessingState(false);
            }
        }

        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Show image preview
        function showImagePreview(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.innerHTML = `
                    <img src="${e.target.result}" alt="Receipt Preview" class="image-preview fade-in">
                    <p style="text-align: center; margin-top: 15px; color: var(--primary-green); font-weight: 600;">
                        <i class="fas fa-check-circle" style="margin-right: 5px;"></i>
                        Receipt uploaded successfully - Processing with AI...
                    </p>
                `;
            };
            reader.readAsDataURL(file);
        }

        // Set processing states
        function setProcessingState(processing) {
            isProcessing = processing;
            
            if (processing) {
                uploadArea.classList.add('disabled');
                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<div class="loading"></div> Processing...';
                progressContainer.style.display = 'block';
                hideResults();
            } else {
                uploadArea.classList.remove('disabled');
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-plus"></i> Choose Receipt';
                progressContainer.style.display = 'none';
            }
        }

        function setMealPlanGenerating(generating) {
            isMealPlanGenerating = generating;
            
            if (generating) {
                generateMealPlanBtn.disabled = true;
                generateMealPlanBtn.innerHTML = '<div class="loading"></div> Generating...';
                mealPlanProgress.style.display = 'block';
                mealPlanDisplay.style.display = 'none';
            } else {
                generateMealPlanBtn.disabled = false;
                generateMealPlanBtn.innerHTML = '<i class="fas fa-magic"></i> Generate Meal Plan';
                mealPlanProgress.style.display = 'none';
            }
        }

        function setShoppingListGenerating(generating) {
            isShoppingListGenerating = generating;
            
            if (generating) {
                generateShoppingListBtn.disabled = true;
                generateShoppingListBtn.innerHTML = '<div class="loading"></div> Generating...';
                shoppingProgress.style.display = 'block';
                shoppingListDisplay.style.display = 'none';
            } else {
                generateShoppingListBtn.disabled = false;
                generateShoppingListBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> Generate Smart List';
                shoppingProgress.style.display = 'none';
            }
        }

        // Process receipt with backend API
        async function processReceiptWithBackend(base64Image) {
            try {
                updateProgress(10, 'Connecting to OCR service...');
                
                const formData = new FormData();
                formData.append('image_data', base64Image);
                formData.append('analysis_type', 'full');
                
                const response = await fetch(`${API_BASE_URL}/api/analyze-receipt`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                    },
                    body: formData
                });

                updateProgress(40, 'Extracting text from receipt...');

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                updateProgress(70, 'Analyzing carbon footprint...');

                if (result.success) {
                    updateProgress(100, 'Analysis complete!');
                    displayReceiptAnalysis(result);
                    
                    // Generate meal prep suggestions based on receipt items
                    if (result.products && result.products.length > 0) {
                        await generateReceiptBasedMealPrep(result.products, result.summary);
                    }
                } else {
                    throw new Error(result.error || 'Receipt analysis failed');
                }

            } catch (error) {
                console.error('Receipt processing error:', error);
                updateProgress(0, 'Analysis failed');
                throw error;
            }
        }

        // NEW: Generate meal prep suggestions based on receipt analysis
        async function generateReceiptBasedMealPrep(products, summary) {
            try {
                const highCarbonItems = products.filter(p => 
                    p.carbon_footprint > 2.0 || 
                    (p.category && ['meat', 'dairy', 'processed'].includes(p.category.toLowerCase()))
                );

                const requestData = {
                    receipt_products: products.map(p => ({
                        name: p.name,
                        category: p.category || 'unknown',
                        carbon_footprint: p.carbon_footprint || 0,
                        price: p.price || 0,
                        quantity: p.quantity || 1
                    })),
                    total_carbon_footprint: summary.total_carbon_footprint || 0,
                    optimization_focus: 'carbon_reduction',
                    meal_count: 7, // Week of meals
                    people_count: 2 // Default
                };

                const response = await fetch(`${API_BASE_URL}/api/generate-receipt-meal-prep`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                if (response.ok) {
                    const mealPrepResult = await response.json();
                    displayReceiptBasedMealPrep(mealPrepResult, highCarbonItems);
                }
            } catch (error) {
                console.warn('Failed to generate receipt-based meal prep:', error);
            }
        }

        // Display receipt analysis results
        function displayReceiptAnalysis(result) {
            displayOCRResults(result.extracted_text || 'Text extraction completed');
            displayProductAnalysis(result.products || []);
            displayStatistics(result.summary || {});
            
            if (result.alternatives && result.alternatives.length > 0) {
                displayAlternatives(result.alternatives);
            }
        }

        // Display OCR results
        function displayOCRResults(extractedText) {
            ocrResults.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <i class="fas fa-eye" style="color: var(--primary-green); margin-right: 10px; font-size: 1.2rem;"></i>
                    <h3 style="color: var(--dark-green); margin: 0;">Text Extracted from Receipt</h3>
                </div>
                <div style="background: var(--white); padding: 20px; border-radius: 10px; border-left: 4px solid var(--primary-green); font-family: 'Courier New', monospace; white-space: pre-wrap; max-height: 200px; overflow-y: auto;">
                    ${extractedText}
                </div>
            `;
        }

        // Display product analysis with enhanced carbon footprint details
        function displayProductAnalysis(products) {
            if (!products || products.length === 0) {
                productAnalysis.innerHTML = '<div class="error-message">No products could be identified from the receipt.</div>';
                return;
            }

            const totalProducts = products.length;
            const highCarbonCount = products.filter(p => (p.carbon_footprint || 0) > 2.0).length;
            
            let html = `
                <div style="display: flex; align-items: center; justify-content: between; margin-bottom: 20px;">
                    <div>
                        <h3 style="color: var(--dark-green); margin: 0; display: flex; align-items: center;">
                            <i class="fas fa-shopping-basket" style="margin-right: 10px; color: var(--primary-green);"></i>
                            Products Identified (${totalProducts})
                        </h3>
                        <p style="color: var(--gray); margin: 5px 0 0 0; font-size: 0.9rem;">
                            ${highCarbonCount} high-carbon items detected
                        </p>
                    </div>
                    <div class="tooltip" style="margin-left: auto;">
                        <button class="btn" onclick="generateAlternativesForAllItems()" style="font-size: 0.9rem; padding: 10px 20px;">
                            <i class="fas fa-leaf"></i>
                            Find Alternatives
                        </button>
                        <span class="tooltiptext">Find sustainable alternatives for high-carbon items</span>
                    </div>
                </div>
            `;

            products.forEach((product, index) => {
                const carbonLevel = getCarbonLevel(product.carbon_footprint || 0);
                const carbonClass = carbonLevel.toLowerCase();
                
                html += `
                    <div class="product-item" data-product-index="${index}">
                        <div style="display: flex; justify-content: between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <strong style="color: var(--dark-green); font-size: 1.1rem;">${product.name}</strong>
                                    <span class="carbon-score ${carbonClass}">${product.carbon_footprint?.toFixed(2) || 'N/A'} kg CO₂</span>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 10px; font-size: 0.9rem;">
                                    ${product.price ? `<span><i class="fas fa-dollar-sign" style="color: var(--primary-green); width: 15px;"></i> $${product.price.toFixed(2)}</span>` : ''}
                                    ${product.quantity ? `<span><i class="fas fa-cubes" style="color: var(--primary-green); width: 15px;"></i> ${product.quantity}</span>` : ''}
                                    ${product.category ? `<span><i class="fas fa-tag" style="color: var(--primary-green); width: 15px;"></i> ${product.category}</span>` : ''}
                                    ${product.confidence ? `<span><i class="fas fa-percentage" style="color: var(--primary-green); width: 15px;"></i> ${(product.confidence * 100).toFixed(0)}% match</span>` : ''}
                                </div>

                                ${product.carbon_footprint > 2.0 ? `
                                    <div style="background: rgba(239, 68, 68, 0.1); padding: 10px; border-radius: 8px; border-left: 3px solid var(--danger); margin-top: 10px;">
                                        <strong style="color: var(--danger); font-size: 0.9rem;">
                                            <i class="fas fa-exclamation-triangle" style="margin-right: 5px;"></i>
                                            High Carbon Impact Item
                                        </strong>
                                        <button class="btn" onclick="findAlternatives(${index})" style="margin-left: 10px; font-size: 0.8rem; padding: 5px 15px;">
                                            <i class="fas fa-exchange-alt"></i>
                                            Find Alternative
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            productAnalysis.innerHTML = html;
        }

        // NEW: Find alternatives for a specific product
        async function findAlternatives(productIndex) {
            const productItems = document.querySelectorAll('.product-item');
            const productItem = productItems[productIndex];
            
            if (!productItem) return;

            // Show loading state
            const button = productItem.querySelector('button');
            const originalHTML = button.innerHTML;
            button.innerHTML = '<div class="loading"></div> Finding...';
            button.disabled = true;

            try {
                // Get product data (this would be stored globally when products are displayed)
                const response = await fetch(`${API_BASE_URL}/api/find-alternatives`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        product_index: productIndex,
                        include_nearby_stores: true,
                        include_price_comparison: true,
                        max_alternatives: 3
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    displayInlineAlternatives(productItem, result.alternatives || []);
                } else {
                    throw new Error('Failed to find alternatives');
                }
            } catch (error) {
                console.error('Error finding alternatives:', error);
                showNotification('Failed to find alternatives. Please try again.', 'error');
            } finally {
                button.innerHTML = originalHTML;
                button.disabled = false;
            }
        }

        // NEW: Display alternatives inline with the product
        function displayInlineAlternatives(productItem, alternatives) {
            if (!alternatives || alternatives.length === 0) {
                return;
            }

            const existingAlts = productItem.querySelector('.inline-alternatives');
            if (existingAlts) {
                existingAlts.remove();
            }

            const alternativesHTML = `
                <div class="inline-alternatives" style="margin-top: 15px; padding: 15px; background: var(--light-green); border-radius: 10px; border-left: 4px solid var(--primary-green);">
                    <h5 style="color: var(--dark-green); margin-bottom: 10px; display: flex; align-items: center;">
                        <i class="fas fa-leaf" style="margin-right: 8px;"></i>
                        Sustainable Alternatives
                    </h5>
                    ${alternatives.map(alt => `
                        <div style="background: var(--white); padding: 12px; margin: 8px 0; border-radius: 8px; display: flex; justify-content: between; align-items: center;">
                            <div>
                                <strong style="color: var(--dark-green);">${alt.name}</strong>
                                ${alt.store_name ? `<br><small style="color: var(--gray);">Available at: ${alt.store_name}</small>` : ''}
                                ${alt.distance_miles ? `<span style="color: var(--gray);"> • ${alt.distance_miles} miles away</span>` : ''}
                            </div>
                            <div style="text-align: right;">
                                <div style="color: var(--primary-green); font-weight: 600;">
                                    ${alt.price ? `$${alt.price.toFixed(2)}` : 'Price varies'}
                                </div>
                                <div style="font-size: 0.8rem; color: var(--gray);">
                                    ${alt.carbon_footprint?.toFixed(2) || 'N/A'} kg CO₂
                                </div>
                                <div style="font-size: 0.8rem; color: var(--primary-green); font-weight: 600;">
                                    Save ${alt.carbon_savings?.toFixed(2) || '0'} kg CO₂
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            productItem.insertAdjacentHTML('beforeend', alternativesHTML);
        }

        // NEW: Display receipt-based meal prep suggestions
        function displayReceiptBasedMealPrep(result, highCarbonItems) {
            if (!result || !result.meal_suggestions) return;

            const mealPrepSection = document.createElement('div');
            mealPrepSection.className = 'alternatives-section fade-in';
            mealPrepSection.style.marginTop = '30px';

            mealPrepSection.innerHTML = `
                <h2 class="card-title">
                    <i class="fas fa-seedling"></i>
                    Carbon-Optimized Meal Prep Suggestions
                </h2>
                <div style="background: var(--light-green); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                    <p style="color: var(--dark-green); margin-bottom: 15px;">
                        <i class="fas fa-lightbulb" style="margin-right: 8px;"></i>
                        Based on your receipt analysis, here are meal prep ideas to reduce your carbon footprint:
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; text-align: center;">
                        <div>
                            <strong>Current Weekly Footprint</strong><br>
                            <span style="color: var(--danger); font-size: 1.2rem;">${result.current_footprint?.toFixed(2) || 'N/A'} kg CO₂</span>
                        </div>
                        <div>
                            <strong>Optimized Footprint</strong><br>
                            <span style="color: var(--primary-green); font-size: 1.2rem;">${result.optimized_footprint?.toFixed(2) || 'N/A'} kg CO₂</span>
                        </div>
                        <div>
                            <strong>Weekly Savings</strong><br>
                            <span style="color: var(--primary-green); font-size: 1.2rem; font-weight: 700;">${result.potential_savings?.toFixed(2) || 'N/A'} kg CO₂</span>
                        </div>
                    </div>
                </div>

                ${result.meal_suggestions.map((suggestion, index) => `
                    <div class="alternative-item" style="flex-direction: column; align-items: stretch; padding: 20px;">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                            <h4 style="color: var(--dark-green); margin: 0;">
                                <i class="fas fa-utensils" style="margin-right: 8px; color: var(--primary-green);"></i>
                                ${suggestion.meal_name}
                            </h4>
                            <div class="savings-badge">
                                Save ${suggestion.carbon_savings?.toFixed(2) || '0'} kg CO₂
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h5 style="color: var(--dark-green); margin-bottom: 8px;">Ingredients from Receipt:</h5>
                                <ul style="margin: 0; padding-left: 20px; color: var(--gray);">
                                    ${(suggestion.receipt_ingredients || []).map(ing => `<li>${ing}</li>`).join('')}
                                </ul>
                            </div>
                            <div>
                                <h5 style="color: var(--dark-green); margin-bottom: 8px;">Additional Needed:</h5>
                                <ul style="margin: 0; padding-left: 20px; color: var(--gray);">
                                    ${(suggestion.additional_ingredients || []).map(ing => `<li>${ing}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 15px; background: var(--white); border-radius: 10px;">
                            <strong style="color: var(--dark-green);">Quick Prep Instructions:</strong>
                            <p style="margin: 8px 0 0 0; color: var(--gray);">${suggestion.prep_instructions || 'Detailed instructions available in full meal plan.'}</p>
                            <div style="margin-top: 10px; font-size: 0.9rem; color: var(--primary-green);">
                                <i class="fas fa-clock" style="margin-right: 5px;"></i>
                                Prep time: ${suggestion.prep_time || '30'} minutes • 
                                Serves: ${suggestion.servings || '4'} • 
                                Storage: ${suggestion.storage_days || '5'} days
                            </div>
                        </div>
                    </div>
                `).join('')}

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="generateFullMealPrepPlan()">
                        <i class="fas fa-calendar-week"></i>
                        Generate Full Week Meal Prep Plan
                    </button>
                </div>
            `;

            // Insert after alternatives section or at the end
            const existingAlts = document.getElementById('alternativesSection');
            if (existingAlts) {
                existingAlts.parentNode.insertBefore(mealPrepSection, existingAlts.nextSibling);
            } else {
                document.querySelector('.container').appendChild(mealPrepSection);
            }
        }

        // Utility functions
        function getCarbonLevel(footprint) {
            if (footprint < 1.0) return 'Low';
            if (footprint < 3.0) return 'Medium';
            return 'High';
        }

        function getCarbonColor(footprint) {
            if (footprint < 1.0) return 'var(--primary-green)';
            if (footprint < 3.0) return 'var(--warning)';
            return 'var(--danger)';
        }

        function displayStatistics(summary) {
            if (!summary || Object.keys(summary).length === 0) {
                statsGrid.style.display = 'none';
                return;
            }

            document.getElementById('totalCarbon').textContent = (summary.total_carbon_footprint || 0).toFixed(2);
            document.getElementById('productCount').textContent = summary.total_products || 0;
            document.getElementById('matchRate').textContent = Math.round((summary.match_rate || 0) * 100);
            document.getElementById('ecoScore').textContent = summary.environmental_score || 'C';
            
            statsGrid.style.display = 'grid';
            statsGrid.classList.add('fade-in');
        }

        function displayAlternatives(alternatives) {
            if (!alternatives || alternatives.length === 0) {
                alternativesSection.style.display = 'none';
                return;
            }

            let html = '';
            alternatives.forEach(alt => {
                html += `
                    <div class="alternative-item">
                        <div>
                            <strong style="color: var(--dark-green);">${alt.original_product}</strong>
                            <br><span style="color: var(--gray);">${alt.alternative_product}</span>
                            <br><small style="color: var(--primary-green);">${alt.reason}</small>
                        </div>
                        <div class="savings-badge">
                            Save ${alt.carbon_reduction?.toFixed(2) || '0'} kg CO₂
                        </div>
                    </div>
                `;
            });

            alternatives.innerHTML = html;
            alternativesSection.style.display = 'block';
            alternativesSection.classList.add('fade-in');
        }

        // Progress and UI updates
        function updateProgress(percentage, message) {
            progressFill.style.width = percentage + '%';
            progressText.textContent = message;
        }

        function updateMealPlanProgress(percentage, message) {
            mealPlanProgressFill.style.width = percentage + '%';
            mealPlanProgressText.textContent = message;
        }

        function updateShoppingProgress(percentage, message) {
            shoppingProgressFill.style.width = percentage + '%';
            shoppingProgressText.textContent = message;
        }

        function hideResults() {
            ocrResults.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--gray);">
                    <i class="fas fa-receipt" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;"></i>
                    <p>Upload a receipt to see detailed carbon footprint analysis...</p>
                </div>
            `;
            productAnalysis.innerHTML = '';
            statsGrid.style.display = 'none';
            alternativesSection.style.display = 'none';
            imagePreview.innerHTML = '';
        }

        function displayError(error) {
            ocrResults.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle" style="margin-right: 10px;"></i>
                    Error: ${error.message || 'Unknown error occurred'}
                </div>
            `;
        }

        function displayMealPlanError(error) {
            mealPlanResults.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle" style="margin-right: 10px;"></i>
                    Failed to generate meal plan: ${error.message || 'Unknown error'}
                </div>
            `;
        }

        function displayShoppingListError(error) {
            shoppingListResults.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle" style="margin-right: 10px;"></i>
                    Failed to generate shopping list: ${error.message || 'Unknown error'}
                </div>
            `;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = type === 'error' ? 'error-message' : 'success-message';
            notification.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 'check-circle'}" style="margin-right: 10px;"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        function disableFeatures(disabled) {
            uploadArea.classList.toggle('disabled', disabled);
            uploadBtn.disabled = disabled;
            generateMealPlanBtn.disabled = disabled;
            generateShoppingListBtn.disabled = disabled;
        }

        // Background animation
        function createFloatingLeaves() {
            const bgAnimation = document.getElementById('bgAnimation');
            const leafEmojis = ['🌱', '🍃', '🌿', '🌾', '🌴'];
            
            for (let i = 0; i < 15; i++) {
                const leaf = document.createElement('div');
                leaf.className = 'floating-leaf';
                leaf.textContent = leafEmojis[Math.floor(Math.random() * leafEmojis.length)];
                leaf.style.left = Math.random() * 100 + '%';
                leaf.style.animationDelay = Math.random() * 15 + 's';
                leaf.style.animationDuration = (Math.random() * 10 + 10) + 's';
                bgAnimation.appendChild(leaf);
            }
        }

        // Global functions for button clicks
        window.findAlternatives = findAlternatives;
        
        window.generateAlternativesForAllItems = async function() {
            showNotification('Finding alternatives for all high-carbon items...', 'info');
            // Implementation would iterate through all high-carbon products
            // and call findAlternatives for each
        };
        
        window.generateFullMealPrepPlan = async function() {
            showNotification('Redirecting to full meal prep planner...', 'info');
            // Scroll to meal planning section and pre-fill based on receipt data
            document.querySelector('.meal-planning-section').scrollIntoView({ behavior: 'smooth' });
        };

        console.log('🌱 GreenLens Enhanced - Receipt-Based Carbon Optimization Ready');
    </script>
</body>
</html>